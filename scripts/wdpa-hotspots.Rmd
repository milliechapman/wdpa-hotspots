---
title: "wdpa"
author: "Millie Chapman"
date: "2/21/2020"
output: github_document
---

```{r setup, include=FALSE}
# load packages
library(tidyverse)
library(dplyr)
library(gridExtra)
library(ggmap)
library(ggpubr)
library(sf)
```


```{r}
cpad <- st_read("../data/CPAD_2020a/CPAD_2020a_Units.shp")
cpad %>% filter(YR_EST >1990) %>% select(UNIT_ID)  %>%plot()
```

```{r}
cced <- st_read("../data/CCED_2020a/CCED_2020a.shp")
cced %>% filter(year_est >1990) %>% select(cced_id) %>% plot()
```

```{r}
sig_hab <- st_read("../data/Terrestrial_Significant_Habitats_Summary_-_ACE_[ds2721]-shp/Terrestrial_Significant_Habitats_Summary_-_ACE_[ds2721].shp")

sig_hab <- as.tibble(sig_hab) %>%
  select(Hex_ID, TerrHabRan, TerrHabTot)
```

```{r}
connectivity <- st_read("../data/Terrestrial_Connectivity_-_ACE_[ds2734]-shp/")
```

```{r}
connectivity %>% filter(County == "ALAMEDA") %>% select(OBJECTID) %>% plot()
```

transform

```{r}
cced <- st_transform(cced, 4326)
cpad <- st_transform(cpad, 4326)
```

```{r cache = TRUE}
int_c_pa <- as_tibble(st_intersection(connectivity, cpad))
int_c_pa %>% filter(County == "MONTEREY") %>% select(geometry) %>% plot()
ccedb<- st_buffer(cced, dist = 0)
int_c_ce <- as_tibble(st_intersection(connectivity, ccedb))
int_c_ce %>% filter(County == "ALAMEDA") %>% select(geometry) %>% plot()
```

```{r}
int_c_ce$ce_area<- st_area(int_c_ce$geometry)

int_c_pa$pa_area<- st_area(int_c_pa$geometry)
```

```{r}
paArea <- int_c_pa %>%
  group_by(Hex_ID) %>%  
  mutate(pa_area = as.numeric(pa_area)) %>%
  summarise(paArea = sum(pa_area))

ceArea <- int_c_ce %>%
  group_by(Hex_ID) %>%
  mutate(ce_area = as.numeric(ce_area)) %>%
  summarise(ceArea = sum(ce_area))
```

```{r}
all <- connectivity %>%
  left_join(ceArea) %>%
  left_join(paArea) 
 
all$tot_area <- st_area(all$geometry)

all <- all %>%
  mutate(tot_area = as.numeric(tot_area)) 

all <- all %>%
  full_join(sig_hab) %>%
  mutate(perc_pa = paArea/tot_area,
         perc_ce = ceArea/tot_area) %>%
  mutate(perc_pa = replace_na(perc_pa, 0),
         perc_ce = replace_na(perc_ce, 0))

mean(all$perc_ce)
mean(all$perc_pa)
```

```{r}
habitat_total <- all %>% select(TerrHabTot, perc_pa, perc_ce) %>%
  group_by(TerrHabTot) %>%
  summarise(perc_pa = mean(perc_pa),
            perc_ce = mean(perc_ce))
```

```{r}
p <- habitat_total %>% ggplot(aes(x = TerrHabTot, y = perc_pa))  + 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Total significant habitat coverage count", y = "Mean percent covered \n by protected areas")
c <- habitat_total %>% ggplot(aes(x = TerrHabTot, y = perc_ce)) + 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Total significant habitat coverage count", y = "Mean percent covered \n by conservation easement")

ggarrange(p,c, nrow = 2) 


```

```{r}
connectivity_total <- all %>% select(Connectivi, perc_pa, perc_ce) %>%
  group_by(Connectivi) %>%
  summarise(perc_pa = mean(perc_pa),
            perc_ce = mean(perc_ce))
```

```{r}
p <- connectivity_total %>% ggplot(aes(x = Connectivi, y = perc_pa))+ 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Connectivity metric", y = "Mean percent covered \n by protected areas")
c <- connectivity_total %>% ggplot(aes(x = Connectivi, y = perc_ce)) + 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Connectivity metric", y = "Mean percent covered \n by conservation easements")

ggarrange(p,c, nrow = 2) 

```

```{r}
biodiversity <- st_read("../data/Species_Biodiversity_-_ACE_%5Bds2769%5D-shp/Species_Biodiversity_-_ACE_%5Bds2769%5D.shp")

biodiversity <- as.tibble(biodiversity) 

biodiv <- biodiversity %>%
  select(Hex_ID, NtvSpRnkEc, RarRnkEco, TerrClimRa, SpBioRnkEc)

all <- all %>%
  full_join(biodiv) 
```

```{r}
biodiversity_total <- all %>% select(SpBioRnkEc, perc_pa, perc_ce) %>%
  group_by(SpBioRnkEc) %>%
  summarise(perc_pa = mean(perc_pa, na.rm = TRUE),
            perc_ce = mean(perc_ce, na.rm = TRUE))
```

```{r}
p <- biodiversity_total %>% ggplot(aes(x = SpBioRnkEc, y = perc_pa))+ 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Biodiversity metric", y = "Mean percent covered \n by protected areas")
c <- biodiversity_total %>% ggplot(aes(x = SpBioRnkEc, y = perc_ce)) + 
  geom_point(shape=19, fill="blue", color="darkred", size=3) + theme_minimal() + 
  labs( x="Biodiversity metric", y = "Mean percent covered \n  by conservation easements")

ggarrange(p,c, nrow = 2) 
```



```{r}

paArea_yr <- int_c_pa %>%
  mutate(pa_area = as.numeric(pa_area)) %>%
  group_by(YR_EST) %>%  
  summarise(paArea = sum(pa_area) ,
            yr_est = mean(YR_EST))

ceArea_yr <- int_c_ce %>%
  group_by(Hex_ID) %>%
  mutate(ce_area = as.numeric(ce_area)) %>%
  summarise(ceArea = sum(ce_area),
            yr_est = mean(year_est))
```


```{r}
paArea_yr <- paArea_yr %>%
  filter(yr_est>0) %>%
  mutate(yr_est_pa = as.factor(round(yr_est, 0)))


ceArea_yr <- ceArea_yr %>%
  filter(yr_est>0) %>%
  mutate(yr_est_ce = as.factor(round(yr_est, 0)))
```



```

